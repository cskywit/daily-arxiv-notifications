name: Arxiv Daily

on:
  # GitHub Actions 的 cron 使用 UTC
  # 下面是：周一到周五，UTC 02:00（北京时间约 10:00）
  schedule:
    - cron: "0 2 * * 1-5"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 如果 main.py 需要 GitHub token（比如访问 API），就保留这个环境变量
      - name: Run main.py (generate mail.html)
        env:
          GITHUB: ${{ secrets.GITHUB }}
        run: |
          python -u main.py

      # 用 mail.html 是否存在且非空，决定是否发送邮件
      - name: Decide whether to send mail
        run: |
          if [ -s mail.html ]; then
            echo "SEND_MAIL=1" >> "$GITHUB_ENV"
            echo "mail.html exists and is non-empty -> will send mail"
          else
            echo "SEND_MAIL=0" >> "$GITHUB_ENV"
            echo "mail.html missing or empty -> skip sending"
          fi

            - name: Send mail (QQ SMTP, Scheme B)
        if: ${{ env.SEND_MAIL == '1' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: 465
          secure: true

          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}

          subject: Arxiv Papers of Today
          to: ${{ secrets.MAIL_TO }}

          # from 必填：优先 MAIL_FROM，否则退化为 MAIL_USERNAME（确保永远不为空）
          from: ${{ secrets.MAIL_FROM || secrets.MAIL_USERNAME }}

          cc: ${{ secrets.MAIL_CC }}
          bcc: ${{ secrets.MAIL_BCC }}

          html_body: file://mail.html
          ignore_cert: true

